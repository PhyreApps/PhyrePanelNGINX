---
kind: pipeline
name: CentOS
steps:
  - name: run nginx build
    image: centos:latest
    commands:
      - sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
      - sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
      - yum update -y
#      - dnf -y install sudo wget
#      - sudo wget -q -O - http://www.atomicorp.com/installers/atomic | sh
#      - dnf -y install geoip-devel perl openssl-devel gd-devel libxslt-devel zlib-devel pcre-devel rpm-build gcc make rpmdevtools rpmlint tree
#
#      - wget https://nginx.org/packages/mainline/centos/7/SRPMS/nginx-1.25.5-1.el7.ngx.src.rpm
#      - rpm -Uvh nginx-1.25.5-1.el7.ngx.src.rpm
#      - cp /drone/src/compilators/centos/nginx/phyre-nginx.spec ~/rpmbuild/SPECS/phyre-nginx.spec
#      - tree ~/rpmbuild
#      - rpmbuild -bb ~/rpmbuild/SPECS/phyre-nginx.spec
      - dnf -y install git
      - mkdir -p /drone/src/deploy.txt
      - touch /drone/src/deploy.txt
      -
      - mkdir -p /drone/src/.ssh
      - touch /drone/src/.ssh/known_hosts

      - touch /drone/src/.ssh/id_rsa
      - echo "${ssh_deploy_key}" > /drone/src/.ssh/id_rsa

      - chmod 0400 /drone/src/.ssh/id_rsa
      - ssh-keyscan -t rsa github.com >> /drone/src/.ssh/known_hosts
      - ssh-keyscan -t rsa github.com | ssh-keygen -lf - 

      - git config --global gpg.format ssh
      - git config --global user.email "drone@phyrecloud.com"
      - git config --global user.signingkey /drone/src/.ssh/id_rsa
      - git clone git@github.com:PhyreApps/Distributions.git /drone/src/Distributions
      - cd /drone/src/Distributions
      - git checkout -b main
      - mv /drone/src/deploy.txt /drone/src/Distributions
      - git add .
      - git commit -m "Deploy to CentOS"
      - git push origin main
      - echo "Deployed to CentOS"
